# Task Instance: django__django-14855

## Repository: django/django

## Problem Description
Wrong URL generated by get_admin_url for readonly field in custom Admin Site
Description
	
When a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....
This appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:
url = reverse(url_name, args=[quote(remote_obj.pk)])
Other parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)
I have been able to correct this specific issue by replacing the above line with:
url = reverse(
	url_name,
	args=[quote(remote_obj.pk)],
	current_app=self.model_admin.admin_site.name
)
However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.


## Solution Process
### Task Understanding
Problem Description: Wrong URL generated by get_admin_url for readonly field in custom Admin Site
Description
	
When a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....
This appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:
url = reverse(url_name, args=[quote(remote_obj.pk)])
Other parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)
I have been able to correct this specific issue by replacing the above line with:
url = reverse(
	url_name,
	args=[quote(remote_obj.pk)],
	current_app=self.model_admin.admin_site.name
)
However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.


Repository: django/django
Pull Request: Unknown

### Files Identified
Files to modify:
- django/contrib/admin/helpers.py

### Task Analysis
Repository: django/django
File Path: django/contrib/admin/helpers.py
Problem Description: Wrong URL generated by get_admin_url for readonly field in custom Admin Site
Description
	
When a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....
This appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:
url = reverse(url_name, args=[quote(remote_obj.pk)])
Other parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)
I have been able to correct this specific issue by replacing the above line with:
url = reverse(
	url_name,
	args=[quote(remote_obj.pk)],
	current_app=self.model_admin.admin_site.name
)
However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.


Initial Assessment:
- Identified file requiring modification: django/contrib/admin/helpers.py
- Task involves: Wrong URL generated by get_admin_url for readonly field in custom Admin Site
Description
	
When a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....
This appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:
url = reverse(url_name, args=[quote(remote_obj.pk)])
Other parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)
I have been able to correct this specific issue by replacing the above line with:
url = reverse(
	url_name,
	args=[quote(remote_obj.pk)],
	current_app=self.model_admin.admin_site.name
)
However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.


### Fix Generation
Successfully generated a fix for the issue.

Generated patch:
```diff
I'll analyze the problem and provide a fix for the incorrect URL generation in custom Admin Sites for readonly ForeignKey fields.

## Problem Analysis

The issue is that when using a custom Admin Site (not the default `/admin/`), readonly ForeignKey fields generate links pointing to the default admin URL instead of the custom admin site URL. This happens because the `reverse()` call doesn't specify which admin site instance to use.

## Solution

The fix involves adding the `current_app` parameter to the `reverse()` call in the `get_admin_url` method. This parameter tells Django's URL resolver which admin site namespace to use when generating the URL.

Here's the precise fix:

```python
# django/contrib/admin/helpers.py

def get_admin_url(self, remote_field, remote_obj):
    """
    Generate a link to the admin change form for the related object.
    """
    url_name = 'admin:%s_%s_change' % (
        remote_field.model._meta.app_label,
        remote_field.model._meta.model_name,
    )
    try:
        url = reverse(
            url_name,
            args=[quote(remote_obj.pk)],
            current_app=self.model_admin.admin_site.name,
        )
        return format_html('<a href="{}">{}</a>', url, remote_obj)
    except NoReverseMatch:
        return str(remote_obj)
```

## Key Changes

1. **Added `current_app` parameter**: This parameter is set to `self.model_admin.admin_site.name`, which contains the name/namespace of the current admin site instance.

2. **Maintains backward compatibility**: For the default admin site (typically named 'admin'), this will still work correctly. For custom admin sites with different names, it will now generate the correct URLs.

## Why This Fix Works

- The `current_app` parameter is the standard Django way to specify which URL namespace to use when reversing URLs
- Other parts of Django admin already use this pattern (e.g., `ModelAdmin.response_add`)
- The `admin_site.name` attribute contains the appropriate namespace identifier for the admin site instance
- This approach is consistent with Django's URL resolution system and admin architecture

## No Negative Side Effects

This fix:
- ✅ Maintains all existing functionality for default admin sites
- ✅ Fixes the bug for custom admin sites
- ✅ Uses the same pattern already established in Django admin codebase
- ✅ Doesn't change the method signature or return type
- ✅ Properly handles the NoReverseMatch exception as before
```

### Validation
Validation Results:
Success: True
Details: No details available

## Final Solution
```diff
diff --git a/django/contrib/admin/helpers.py b/django/contrib/admin/helpers.py
--- a/django/contrib/admin/helpers.py
+++ b/django/contrib/admin/helpers.py
@@ -209,7 +209,11 @@ def get_admin_url(self, remote_field, remote_obj):
             remote_field.model._meta.model_name,
         )
         try:
-            url = reverse(url_name, args=[quote(remote_obj.pk)])
+            url = reverse(
+                url_name,
+                args=[quote(remote_obj.pk)],
+                current_app=self.model_admin.admin_site.name,
+            )
             return format_html('<a href="{}">{}</a>', url, remote_obj)
         except NoReverseMatch:
             return str(remote_obj)

```